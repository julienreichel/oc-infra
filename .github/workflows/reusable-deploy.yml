name: Reusable Deploy
on:
  workflow_call:
    inputs:
      app_kind:   { required: true, type: string }
      image_name: { required: true, type: string }
      namespace:  { required: true, type: string }
      host:       { required: false, type: string }
      run_migrations: { required: false, type: boolean, default: false }
      migration_command: { required: false, type: string, default: "npm run db:migrate" }
    secrets:
      CR_PAT: { required: true }
      KUBECONFIG_CONTENT: { required: true }

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-kubectl@v4

      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Run Database Migrations
        if: ${{ inputs.run_migrations }}
        run: |
          TAG=${{ github.sha }}
          IMAGE="${{ inputs.image_name }}:${TAG}"
          TIMESTAMP=$(date +%s)
          JOB_NAME="migration-job-${TIMESTAMP}"
          
          echo "Creating migration job: $JOB_NAME"
          
          cat <<EOF | kubectl -n "${{ inputs.namespace }}" apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: $JOB_NAME
            namespace: ${{ inputs.namespace }}
          spec:
            ttlSecondsAfterFinished: 300
            backoffLimit: 3
            template:
              spec:
                restartPolicy: Never
                containers:
                - name: migration
                  image: $IMAGE
                  command: ["/bin/sh", "-c"]
                  args: ["${{ inputs.migration_command }}"]
                  envFrom:
                  - secretRef:
                      name: db
                  env:
                  - name: NODE_ENV
                    value: "production"
          EOF
          
          echo "Waiting for migration job to complete..."
          kubectl -n "${{ inputs.namespace }}" wait --for=condition=complete job/$JOB_NAME --timeout=300s
          
          # Check job status and logs
          JOB_STATUS=$(kubectl -n "${{ inputs.namespace }}" get job $JOB_NAME -o jsonpath='{.status.conditions[?(@.type=="Complete")].status}')
          if [ "$JOB_STATUS" != "True" ]; then
            echo "Migration job failed. Job logs:"
            kubectl -n "${{ inputs.namespace }}" logs job/$JOB_NAME --tail=50
            exit 1
          fi
          
          echo "Migration completed successfully"

      - name: Apply Deployment
        run: |
          TAG=${{ github.sha }}
          IMAGE="${{ inputs.image_name }}:${TAG}"
          sed "s|IMAGE_PLACEHOLDER|$IMAGE|g" k8s/deployment.yaml \
            | kubectl -n "${{ inputs.namespace }}" apply -f -

      - name: Apply Service
        run: kubectl -n "${{ inputs.namespace }}" apply -f k8s/service.yaml

      - name: Apply Ingress (frontend only)
        if: ${{ inputs.app_kind == 'frontend' }}
        run: |
          [ -n "${{ inputs.host }}" ] || { echo "host required"; exit 1; }
          sed "s|__HOST__|${{ inputs.host }}|g" k8s/ingress.yaml \
            | kubectl -n "${{ inputs.namespace }}" apply -f -

      - name: Rollout status
        run: |
          DEPLOY_NAME=$(grep -m1 -E '^  name:' k8s/deployment.yaml | awk '{print $2}')
          kubectl -n "${{ inputs.namespace }}" rollout status deploy/$DEPLOY_NAME --timeout=120s || true
