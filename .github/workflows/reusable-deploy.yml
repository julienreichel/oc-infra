name: Reusable Deploy
on:
  workflow_call:
    inputs:
      app_kind:   { required: true, type: string }
      image_name: { required: true, type: string }
      namespace:  { required: true, type: string }
      host:       { required: false, type: string }
    secrets:
      CR_PAT: { required: true }
      KUBECONFIG_CONTENT: { required: true }

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-kubectl@v4

      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Apply Deployment
        run: |
          TAG=${{ github.sha }}
          IMAGE="${{ inputs.image_name }}:${TAG}"
          sed "s|IMAGE_PLACEHOLDER|$IMAGE|g" k8s/deployment.yaml \
            | kubectl -n "${{ inputs.namespace }}" apply -f -

      - name: Apply Service
        run: kubectl -n "${{ inputs.namespace }}" apply -f k8s/service.yaml

      - name: Apply Ingress (frontend only)
        if: ${{ inputs.app_kind == 'frontend' }}
        run: |
          [ -n "${{ inputs.host }}" ] || { echo "host required"; exit 1; }
          sed "s|__HOST__|${{ inputs.host }}|g" k8s/ingress.yaml \
            | kubectl -n "${{ inputs.namespace }}" apply -f -

      - name: Rollout status
        run: |
          DEPLOY_NAME=$(grep -m1 -E '^  name:' k8s/deployment.yaml | awk '{print $2}')
          kubectl -n "${{ inputs.namespace }}" rollout status deploy/$DEPLOY_NAME --timeout=120s || true
