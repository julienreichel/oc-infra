name: CI/CD

on:
  push:
    branches: ['main']
  pull_request:

jobs:
  ensure-ghcr-secrets:
    name: Ensure GHCR secrets exist per namespace
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ns: [ oc-provider, oc-client, oc-dev-provider, oc-dev-client ]  # add more envs as needed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Write kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Ensure namespace exists
        run: |
          kubectl get ns "${{ matrix.ns }}" >/dev/null 2>&1 || kubectl create ns "${{ matrix.ns }}"

      - name: Create/Update GHCR imagePullSecret (idempotent)
        env:
          GHCR_USER: ${{ github.actor }}
          GHCR_TOKEN: ${{ secrets.CR_PAT }}
        run: |
          kubectl -n "${{ matrix.ns }}" create secret docker-registry ghcr-creds \
            --docker-server=ghcr.io \
            --docker-username="${GHCR_USER}" \
            --docker-password="${GHCR_TOKEN}" \
            --docker-email="none@none" \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create/Update DB secrets 
        shell: bash
        run: |
          ns="${{ matrix.ns }}"

          DB="db"
          USR="app"
          PWD="${{ secrets.DB_PASSWORD }}"

          kubectl -n "$ns" create secret generic db-secret \
            --from-literal=POSTGRES_DB="$DB" \
            --from-literal=POSTGRES_USER="$USR" \
            --from-literal=POSTGRES_PASSWORD="$PWD" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$ns" create secret generic db \
            --from-literal=DATABASE_URL="postgres://${USR}:${PWD}@pg:5432/${DB}" \
            --dry-run=client -o yaml | kubectl apply -f -

  deploy:
    name: Deploy manifests
    runs-on: ubuntu-latest
    needs: [ensure-ghcr-secrets]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Write kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Deploy manifests
        run: |
          # Namespaces & shared infra
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/clusterissuer-letsencrypt-prod.yaml

      - name: Deploy DBs (same manifest, different namespaces)
        shell: bash
        run: |
          for ns in oc-provider oc-dev-provider oc-client oc-dev-client; do
            kubectl -n "$ns" apply -f k8s/postgres.yaml
          done
